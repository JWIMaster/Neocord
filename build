#!/bin/bash

PROJECT_NAME="Neocord"
OUTPUT_FOLDER="builddir"
BUILD_DIR="./builddir"
TOOLCHAIN_ID="org.swift.5101202406041a"
SWIFT_LIB_PATH="/Library/Developer/Toolchains/swift-5.1.5-RELEASE.xctoolchain/usr/lib/swift/iphoneos"

echo "ðŸ§¹ Cleaning old build artifacts..."
rm -rf "$BUILD_DIR"
mkdir -p "$OUTPUT_FOLDER"

build_ipa() {
  local archs="$1"
  local ipa_suffix="$2"
  local archive_path="$BUILD_DIR/${PROJECT_NAME}-${ipa_suffix}.xcarchive"
  local app_path="$archive_path/Products/Applications/${PROJECT_NAME}.app"
  local ipa_name="${PROJECT_NAME}-${ipa_suffix}.ipa"
  local payload_dir="$BUILD_DIR/Payload"

  echo "ðŸ“¦ Archiving project: $PROJECT_NAME ($archs)..."

  /Applications/Xcode13.app/Contents/Developer/usr/bin/xcodebuild archive \
    -scheme "$PROJECT_NAME" \
    -configuration Release \
    -sdk iphoneos \
    TOOLCHAINS="$TOOLCHAIN_ID" \
    IPHONEOS_DEPLOYMENT_TARGET=7.0 \
    ARCHS="$archs" \
    CODE_SIGN_IDENTITY="" \
    CODE_SIGNING_REQUIRED=NO \
    CODE_SIGNING_ALLOWED=NO \
    -archivePath "$archive_path" \
    clean archive

  if [ ! -d "$app_path" ]; then
    echo "âŒ Archive failed or .app not found at $app_path"
    exit 1
  fi

  # Copy Swift dylibs
  FRAMEWORKS_DIR="$app_path/Frameworks"
  mkdir -p "$FRAMEWORKS_DIR"
  echo "ðŸ“Œ Copying Swift dylibs..."
  for dylib in "$SWIFT_LIB_PATH"/*.dylib; do
    cp -f "$dylib" "$FRAMEWORKS_DIR/"
  done

  # Update MinimumOSVersion
  PLIST_PATH="$app_path/Info.plist"
  if [ -f "$PLIST_PATH" ]; then
    echo "ðŸ”§ Updating MinimumOSVersion to 6.0..."
    /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 6.0" "$PLIST_PATH"
  fi

  # Package IPA
  rm -rf "$payload_dir"
  mkdir -p "$payload_dir"
  cp -R "$app_path" "$payload_dir/"

  pushd "$BUILD_DIR" >/dev/null
  zip -qry "$ipa_name" Payload
  popd >/dev/null

  rm -rf "$payload_dir"
  rm -rf "$archive_path"

  mv "$BUILD_DIR/$ipa_name" "$OUTPUT_FOLDER/"
  echo "âœ… IPA ($archs) exported to: $OUTPUT_FOLDER/$ipa_name"
}

# Build armv7-only IPA
build_ipa "armv7" "armv7"

# Build armv7 + arm64 IPA
build_ipa "armv7 arm64" "armv7-arm64"
